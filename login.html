<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>676Trades - Login</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tabbtn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:transparent;color:inherit;cursor:pointer}
    .tabbtn.active{background:rgba(255,255,255,.08)}
    .hint{opacity:.75;font-size:12px;margin-top:6px}
    .link{color:inherit;text-decoration:underline;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    .ok{color:#22c55e}
    .err{color:#f97316}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div><b>676Trades</b></div>
      <div style="display:flex;gap:12px;align-items:center;">
        <a href="/index.html">Home</a>
        <a href="/billing.html">Billing</a>
      </div>
    </div>

    <div class="card">
      <h1>Login</h1>
      <div class="small">Sign in to manage your EA.</div>

      <div class="tabs">
        <button id="tabLogin" class="tabbtn active" type="button">Login</button>
        <button id="tabForgot" class="tabbtn" type="button">Forgot password</button>
        <button id="tabReset" class="tabbtn" type="button" style="display:none;">Reset password</button>
      </div>

      <div id="msg" class="toast"></div>

      <!-- LOGIN -->
      <div id="panelLogin" style="margin-top:14px;">
        <div class="row">
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
          </div>
          <div>
            <label>Password</label>
            <input id="password" type="password" placeholder="••••••••" autocomplete="current-password"/>
            <div class="hint">
              Forgot it? <span class="link" id="goForgot">Reset here</span>
            </div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
            <button id="loginBtn">Login</button>
            <button class="secondary" type="button" id="goRegisterBtn">Create account</button>
          </div>
        </div>
      </div>

      <!-- FORGOT -->
      <div id="panelForgot" style="margin-top:14px; display:none;">
        <div class="small">
          Enter your email and we’ll send a reset link (if the account exists).
        </div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>Email</label>
            <input id="forgotEmail" type="email" placeholder="you@example.com" autocomplete="email"/>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
            <button id="forgotBtn">Send reset link</button>
            <button class="secondary" type="button" id="backToLogin1">Back</button>
          </div>
        </div>
      </div>

      <!-- RESET -->
      <div id="panelReset" style="margin-top:14px; display:none;">
        <div class="small">
          Set a new password for your account.
        </div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>New password</label>
            <input id="newPassword" type="password" placeholder="New password" autocomplete="new-password"/>
            <div class="hint">Use at least 8 characters.</div>
          </div>
          <div>
            <label>Confirm new password</label>
            <input id="newPassword2" type="password" placeholder="Confirm new password" autocomplete="new-password"/>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
            <button id="resetBtn">Reset password</button>
            <button class="secondary" type="button" id="backToLogin2">Back</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const msg = document.getElementById("msg");

    const tabLogin = document.getElementById("tabLogin");
    const tabForgot = document.getElementById("tabForgot");
    const tabReset = document.getElementById("tabReset");

    const panelLogin = document.getElementById("panelLogin");
    const panelForgot = document.getElementById("panelForgot");
    const panelReset = document.getElementById("panelReset");

    function setMsg(text, kind=""){
      msg.textContent = text || "";
      msg.className = "toast" + (kind ? (" " + kind) : "");
    }

    function activateTab(which){
      tabLogin.classList.remove("active");
      tabForgot.classList.remove("active");
      tabReset.classList.remove("active");

      panelLogin.style.display = "none";
      panelForgot.style.display = "none";
      panelReset.style.display = "none";

      if(which === "login"){
        tabLogin.classList.add("active");
        panelLogin.style.display = "";
      }else if(which === "forgot"){
        tabForgot.classList.add("active");
        panelForgot.style.display = "";
      }else if(which === "reset"){
        tabReset.classList.add("active");
        panelReset.style.display = "";
      }
      setMsg("");
    }

    function getResetToken(){
      const p = new URLSearchParams(window.location.search);
      return (p.get("reset_token") || "").trim();
    }

    // ---- Login
    document.getElementById("loginBtn").onclick = async () => {
      setMsg("Logging in...");
      try{
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const r = await fetch(`${BACKEND}/auth/login`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({email,password})
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data.error || "Login failed");
        setToken(data.api_key);
        setMsg("✅ Logged in.", "ok");
        window.location.href="/dashboard.html";
      }catch(e){
        setMsg("Error: " + e.message, "err");
      }
    };

    // ---- Forgot
    document.getElementById("forgotBtn").onclick = async () => {
      setMsg("Sending reset link...");
      try{
        const email = document.getElementById("forgotEmail").value.trim();
        if(!email) throw new Error("Enter your email.");
        const r = await fetch(`${BACKEND}/auth/forgot-password`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({email})
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data.error || "Request failed");
        // Don't reveal whether email exists; backend should behave same way.
        setMsg("✅ If that email exists, a reset link was sent. Check inbox/spam.", "ok");
      }catch(e){
        setMsg("Error: " + e.message, "err");
      }
    };

    // ---- Reset
    document.getElementById("resetBtn").onclick = async () => {
      setMsg("Resetting password...");
      try{
        const token = getResetToken();
        if(!token) throw new Error("Missing reset token. Use the link from your email.");
        const p1 = document.getElementById("newPassword").value;
        const p2 = document.getElementById("newPassword2").value;
        if(!p1 || p1.length < 8) throw new Error("Password must be at least 8 characters.");
        if(p1 !== p2) throw new Error("Passwords do not match.");

        const r = await fetch(`${BACKEND}/auth/reset-password`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({token, new_password:p1})
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data.error || "Reset failed");

        setMsg("✅ Password updated. Please login.", "ok");

        // Clean URL (remove token) after success
        const clean = window.location.origin + window.location.pathname;
        window.history.replaceState({}, "", clean);

        activateTab("login");
      }catch(e){
        setMsg("Error: " + e.message, "err");
      }
    };

    // ---- Nav
    document.getElementById("goRegisterBtn").onclick = () => window.location.href="/register.html";
    document.getElementById("goForgot").onclick = () => activateTab("forgot");
    document.getElementById("backToLogin1").onclick = () => activateTab("login");
    document.getElementById("backToLogin2").onclick = () => activateTab("login");

    tabLogin.onclick = () => activateTab("login");
    tabForgot.onclick = () => activateTab("forgot");
    tabReset.onclick = () => activateTab("reset");

    // ---- Boot: if token exists, show Reset tab
    const rt = getResetToken();
    if(rt){
      tabReset.style.display = "";
      activateTab("reset");
    }else{
      activateTab("login");
    }
  </script>
</body>
</html>
