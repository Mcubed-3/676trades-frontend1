<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>676Trades - Dashboard</title>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    .badge.live { background:#16a34a; color:white; }
    .badge.dead { background:#f59e0b; color:black; }
    .smallmuted { opacity:0.75; font-size:12px; margin-top:6px; }

    .banner{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,180,0,0.08);
      border-radius:14px;
      padding:14px 14px;
      margin-bottom:14px;
    }
    .banner h3{ margin:0 0 6px 0; font-size:16px; }
    .banner .muted{ opacity:0.85; font-size:13px; line-height:1.35; }
    .banner .rowline{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .checkline{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .checkline input{ width:18px; height:18px; }
    .dangertext{ color:#ffb4b4; font-size:12px; opacity:0.9; }
    .btn-disabled{
      opacity:0.55;
      pointer-events:none;
      filter: grayscale(25%);
    }

    /* Beginner UI blocks */
    .section-title{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:0 0 10px 0;
    }
    .section-title h2{ margin:0; }
    details.adv{
      margin-top:12px;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      background:#0b1528;
      padding:10px 12px;
    }
    details.adv summary{
      cursor:pointer;
      user-select:none;
      font-weight:800;
      list-style:none;
    }
    details.adv summary::-webkit-details-marker{display:none;}
    .hint{
      font-size:12px;
      opacity:.82;
      line-height:1.35;
      margin-top:6px;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- RISK / COMPLIANCE BANNER -->
    <div class="banner">
      <h3>Risk disclaimer</h3>
      <div class="muted">
        Automated trading involves risk and can result in losses. 676Trades does not provide financial advice.
        Use at your own risk. Past performance is not indicative of future results.
      </div>

      <div class="rowline">
        <label class="checkline">
          <input id="riskCheck" type="checkbox"/>
          <span class="muted"><b>I understand the risk</b> and want to enable automated trading.</span>
        </label>
        <div id="riskHint" class="dangertext" style="display:none;">
          Please tick the checkbox to enable “Start Algo”.
        </div>
      </div>
    </div>

    <div class="nav">
      <div><b>676Trades</b></div>
      <div style="display:flex;gap:12px;align-items:center;">
        <a href="/setup2.html">Setup</a>
        <a href="/account2.html">Account</a>
        <a href="/billing.html">Billing</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>

    <!-- STATUS CARD -->
    <div class="card">
      <h1>Dashboard</h1>
      <div class="small">Choose your market + lot size. Save, then Start.</div>
      <hr/>

      <div class="kv">
        <div><b>Status</b><span id="statusBadge" class="badge off">OFF</span></div>
        <div><b>Markets</b><span id="pairsText">-</span></div>
        <div><b>Lot size</b><span id="lotText">-</span></div>

        <div><b>EA</b>
          <span id="eaBadge" class="badge dead">Offline ⚠️</span>
        </div>
        <div><b>Last seen</b><span id="lastSeenText">-</span></div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="startBtn">Start Algo</button>
        <button id="stopBtn" class="danger">Stop Algo</button>
        <button id="refreshBtn" class="secondary">Refresh</button>
      </div>

      <div id="msg" class="toast"></div>
      <div class="smallmuted">EA becomes “Connected” after a heartbeat within the last 5 minutes.</div>
    </div>

    <!-- SIMPLE SETTINGS CARD (BEGINNER) -->
    <div class="card">
      <div class="section-title">
        <h2>Trading Settings</h2>
        <div class="small">
          <span class="info" data-tip="Keep it simple: pick a market, set lot size, then Save.">?</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label>
            Choose markets
            <span class="info" data-tip="Tap buttons to select. You can pick more than one.">?</span>
          </label>

          <!-- Button selector -->
          <div id="pairButtons" class="pair-grid"></div>

          <!-- Underlying input that gets saved -->
          <input id="pairs" placeholder="XAUUSD,EURUSD,GBPUSD,USDJPY" style="margin-top:10px;" />

          <div class="hint">
            We currently support <b>Gold (XAUUSD)</b> and major FX pairs. Crypto & indices are temporarily locked while dedicated strategies are developed.
          </div>
        </div>

        <div>
          <label>
            Lot Size
            <span class="info" data-tip="Lot size controls trade size. If you’re new, start small (example: 0.01).">?</span>
          </label>
          <input id="lot" type="number" step="0.01" value="0.01"/>
          <div class="hint">Beginner suggestion: start with <b>0.01</b> and increase only when you understand risk.</div>
        </div>
      </div>

      <!-- Advanced (collapsed by default) -->
      <details class="adv">
        <summary>
          Advanced (optional)
          <span class="info" data-tip="Only adjust these if you understand what they do. Defaults are fine for beginners.">?</span>
        </summary>

        <div style="margin-top:10px;" class="row">
          <div>
            <label>
              SL Mode
              <span class="info" data-tip="Stop Loss style. Dynamic uses candle patterns. Fixed uses a set distance.">?</span>
            </label>
            <select id="sl_mode">
              <option value="dynamic">Dynamic (pattern-based)</option>
              <option value="fixed">Fixed</option>
            </select>
          </div>

          <div>
            <label>
              TP Mode
              <span class="info" data-tip="Take Profit style. RR means profit is a multiple of risk.">?</span>
            </label>
            <select id="tp_mode">
              <option value="rr">Risk / Reward (RR)</option>
              <option value="pattern_mult">Pattern multiplier</option>
              <option value="fixed">Fixed</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Minimum pips</label>
            <input id="min_pips" type="number" value="50"/>
          </div>
          <div>
            <label>SL buffer pips</label>
            <input id="sl_buffer_pips" type="number" value="5"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>RR</label>
            <input id="rr" type="number" step="0.1" value="1.0"/>
          </div>
          <div>
            <label>Pattern TP Multiplier</label>
            <input id="pattern_tp_mult" type="number" step="0.1" value="1.5"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Fixed SL pips</label>
            <input id="fixed_sl_pips" type="number" value="50"/>
          </div>
          <div>
            <label>Fixed TP pips</label>
            <input id="fixed_tp_pips" type="number" value="50"/>
          </div>
        </div>
      </details>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="saveBtn">Save Settings</button>
        <button id="copyKeyBtn" class="secondary">Copy API Key</button>
      </div>

      <div id="msg2" class="toast"></div>
    </div>

  </div>

  <footer class="footer">
    <div class="footer-inner">
      <span>© <span id="yr"></span> 676Trades</span>
      <span class="dot">·</span>
      <a href="/terms.html">Terms</a>
      <span class="dot">·</span>
      <a href="/privacy.html">Privacy</a>
      <span class="dot">·</span>
      <a href="/risk.html">Risk Disclosure</a>
      <span class="dot">·</span>
      <a href="mailto:support@676trades.org">Support</a>
    </div>
  </footer>

  <script>
    (function(){
      var el = document.getElementById("yr");
      if(el) el.textContent = new Date().getFullYear();
    })();
  </script>

  <script src="app.js"></script>
  <script>
    const msg = document.getElementById("msg");
    const msg2 = document.getElementById("msg2");

    const startBtn = document.getElementById("startBtn");
    const riskCheck = document.getElementById("riskCheck");
    const riskHint = document.getElementById("riskHint");

    function requireLogin(){
      if(!getToken()){
        window.location.href="/login.html";
        return false;
      }
      return true;
    }

    function updateStartGate(){
      const ok = !!riskCheck.checked;
      if(ok){
        startBtn.classList.remove("btn-disabled");
        riskHint.style.display = "none";
      }else{
        startBtn.classList.add("btn-disabled");
      }
      return ok;
    }

    riskCheck.addEventListener("change", updateStartGate);

    function copyKey(){
      navigator.clipboard.writeText(getApiKey() || "");
      msg2.textContent = "API key copied.";
    }

    function pickPairs(s){
      return (s.pairs || s.pair || "XAUUSD");
    }

    function fillForm(s){
      const pairsVal = pickPairs(s);

      document.getElementById("pairs").value = pairsVal;
      document.getElementById("lot").value = (s.lot_size ?? 0.01);

      document.getElementById("sl_mode").value = (s.sl_mode || "dynamic");
      document.getElementById("tp_mode").value = (s.tp_mode || "rr");

      document.getElementById("min_pips").value = (s.min_pips ?? 50);
      document.getElementById("sl_buffer_pips").value = (s.sl_buffer_pips ?? 5);

      document.getElementById("rr").value = (s.rr ?? 1.0);
      document.getElementById("pattern_tp_mult").value = (s.pattern_tp_mult ?? 1.5);

      document.getElementById("fixed_sl_pips").value = (s.fixed_sl_pips ?? 50);
      document.getElementById("fixed_tp_pips").value = (s.fixed_tp_pips ?? 50);

      const badge = document.getElementById("statusBadge");
      badge.textContent = s.enabled ? "ON" : "OFF";
      badge.className = "badge " + (s.enabled ? "ok" : "off");

      document.getElementById("pairsText").textContent = pairsVal;
      document.getElementById("lotText").textContent = (s.lot_size ?? "-");

      const eaBadge = document.getElementById("eaBadge");
      const lastSeen = document.getElementById("lastSeenText");

      if(s.ea_connected){
        eaBadge.textContent = "Connected ✅";
        eaBadge.className = "badge live";
      }else{
        eaBadge.textContent = "Offline ⚠️";
        eaBadge.className = "badge dead";
      }

      lastSeen.textContent = s.last_seen_at ? new Date(s.last_seen_at).toLocaleString() : "-";

      // sync buttons UI
      syncPairButtonsFromInput();
    }

    async function refresh(){
      msg.textContent = "Loading...";
      try{
        const s = await api("/api/v1/status","GET");
        fillForm(s);
        msg.textContent = "";
      }catch(e){
        msg.textContent = "Error: " + e.message;
      }
    }

    document.getElementById("refreshBtn").onclick = refresh;

    startBtn.onclick = async ()=>{
      if(!updateStartGate()){
        riskHint.style.display = "block";
        msg.textContent = "Please confirm the risk disclaimer first.";
        return;
      }

      msg.textContent = "Starting...";
      try{
        await api("/api/v1/toggle","POST",{ enabled:true });
        await refresh();
        msg.textContent = "Started.";
      }catch(e){
        msg.textContent = "Error: " + e.message;
      }
    };

    document.getElementById("stopBtn").onclick = async ()=>{
      msg.textContent = "Stopping...";
      try{
        await api("/api/v1/toggle","POST",{ enabled:false });
        await refresh();
        msg.textContent = "Stopped.";
      }catch(e){ msg.textContent = "Error: " + e.message; }
    };

    document.getElementById("saveBtn").onclick = async ()=>{
      msg2.textContent = "Saving...";
      try{
        await api("/api/v1/settings","POST",{
          pairs: document.getElementById("pairs").value.trim(),
          lot_size: Number(document.getElementById("lot").value),

          sl_mode: document.getElementById("sl_mode").value,
          tp_mode: document.getElementById("tp_mode").value,

          min_pips: Number(document.getElementById("min_pips").value),
          sl_buffer_pips: Number(document.getElementById("sl_buffer_pips").value),

          rr: Number(document.getElementById("rr").value),
          pattern_tp_mult: Number(document.getElementById("pattern_tp_mult").value),

          fixed_sl_pips: Number(document.getElementById("fixed_sl_pips").value),
          fixed_tp_pips: Number(document.getElementById("fixed_tp_pips").value)
        });

        msg2.textContent = "Saved. EA will pick this up on next poll.";
        await refresh();
      }catch(e){
        msg2.textContent = "Error: " + e.message;
      }
    };

    document.getElementById("copyKeyBtn").onclick = async ()=>{
      const key = getApiKey() || "";
      if(!key){
        msg2.textContent = "No API key found yet. Login again if needed.";
        return;
      }
      await navigator.clipboard.writeText(key);
      msg2.textContent = "API key copied.";
    };

    // ----------------------------
    // Pair Buttons (Allowed + Locked)
    // ----------------------------
    const ALLOWED = [
      { sym:"XAUUSD", label:"Gold (XAUUSD)", tip:"Gold. Supported." },
      { sym:"EURUSD", label:"EURUSD", tip:"Major FX. Supported." },
      { sym:"GBPUSD", label:"GBPUSD", tip:"Major FX. Supported." },
      { sym:"USDJPY", label:"USDJPY", tip:"Major FX. Supported." },
    ];

    const LOCKED = [
      { sym:"BTCUSD", label:"BTCUSD", tip:"Locked for now (crypto strategy coming soon)." },
      { sym:"NAS100", label:"NAS100", tip:"Locked for now (index strategy coming soon)." },
      { sym:"US30",  label:"US30",  tip:"Locked for now (index strategy coming soon)." },
    ];

    function parsePairsInput(){
      const raw = (document.getElementById("pairs").value || "").trim();
      if(!raw) return [];
      return raw.split(",").map(s=>s.trim().toUpperCase()).filter(Boolean);
    }

    function setPairsInput(list){
      const unique = [];
      const seen = new Set();
      for(const x of list){
        if(!seen.has(x)){
          seen.add(x);
          unique.push(x);
        }
      }
      document.getElementById("pairs").value = unique.join(",");
    }

    function buildPairButtons(){
      const wrap = document.getElementById("pairButtons");
      wrap.innerHTML = "";

      function makeBtn(item, locked=false){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "pair-btn" + (locked ? " locked" : "");
        btn.setAttribute("data-sym", item.sym);
        btn.innerHTML = `
          <span>${item.label}</span>
          <span class="info" data-tip="${item.tip}">?</span>
          ${locked ? `<span class="locktag">Locked</span>` : ``}
        `;

        if(locked){
          btn.disabled = true;
          btn.classList.add("disabled");
          return btn;
        }

        btn.onclick = () => {
          const cur = parsePairsInput();
          const sym = item.sym;

          const has = cur.includes(sym);
          const next = has ? cur.filter(x=>x!==sym) : cur.concat([sym]);
          setPairsInput(next);
          syncPairButtonsFromInput();
        };

        return btn;
      }

      // allowed
      for(const a of ALLOWED){
        wrap.appendChild(makeBtn(a,false));
      }

      // locked
      const sep = document.createElement("div");
      sep.className = "pair-sep";
      sep.textContent = "Locked markets (coming soon)";
      wrap.appendChild(sep);

      for(const l of LOCKED){
        wrap.appendChild(makeBtn(l,true));
      }
    }

    function syncPairButtonsFromInput(){
      const cur = new Set(parsePairsInput());
      document.querySelectorAll(".pair-btn").forEach(btn=>{
        const sym = btn.getAttribute("data-sym");
        if(!sym) return;
        if(btn.classList.contains("locked")) return;
        if(cur.has(sym)) btn.classList.add("selected");
        else btn.classList.remove("selected");
      });
    }

    // init
    if(requireLogin()){
      buildPairButtons();
      updateStartGate();
      refresh();
    }
  </script>
</body>
</html>
