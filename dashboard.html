<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>676Trades - Dashboard</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .badge.live { background:#16a34a; color:white; }
    .badge.dead { background:#f59e0b; color:black; }
    .smallmuted { opacity:0.75; font-size:12px; margin-top:6px; }

    .banner{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,180,0,0.08);
      border-radius:14px;
      padding:14px;
      margin-bottom:14px;
    }
    .banner h3{ margin:0 0 6px 0; font-size:16px; }
    .banner .muted{ opacity:0.85; font-size:13px; line-height:1.35; }
    .banner .rowline{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .checkline{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .checkline input{ width:18px; height:18px; }
    .dangertext{ color:#ffb4b4; font-size:12px; opacity:0.9; }
    .btn-disabled{
      opacity:0.55;
      pointer-events:none;
      filter: grayscale(20%);
    }

    .hint{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(34,197,94,0.08);
      margin-top:10px;
      font-size:13px;
      color:rgba(255,255,255,0.92);
    }
    .hint b{color:#bfffe0;}

    .label-row{display:flex;align-items:center;gap:8px;}
    .info{
      display:inline-flex;align-items:center;justify-content:center;
      width:18px;height:18px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.06);
      color:rgba(255,255,255,0.85);
      font-size:12px;cursor:help;position:relative;flex:0 0 auto;
    }
    .info .tip{
      display:none;position:absolute;left:0;top:22px;width:280px;max-width:70vw;
      z-index:30;padding:10px;border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:#071024;color:rgba(255,255,255,0.92);
      font-size:12px;line-height:1.35;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    }
    .info:hover .tip{display:block;}
    @media(max-width:720px){
      .info:hover .tip{display:none;}
      .info.open .tip{display:block;}
    }

    /* Pair chips */
    .chipwrap{margin-top:10px;}
    .chipgroup-title{margin-top:12px;font-size:12px;opacity:0.8;}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.05);
      color:rgba(255,255,255,0.9);
      font-weight:800;
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    .chip:hover{background:rgba(255,255,255,0.08);}
    .chip.on{
      background:rgba(79,124,255,0.22);
      border-color:rgba(79,124,255,0.55);
    }
    .chip small{opacity:0.75;font-weight:700;margin-left:6px;}
    .chiprow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .chipbtn{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);
      background:#0b1528;color:rgba(255,255,255,0.9);font-weight:800;cursor:pointer;
    }
    .chipbtn:hover{background:rgba(255,255,255,0.06);}
  </style>
</head>
<body>
  <div class="container">

    <div class="banner">
      <h3>Risk disclaimer</h3>
      <div class="muted">
        Automated trading involves risk and can result in losses. 676Trades does not provide financial advice.
        Use at your own risk.
      </div>

      <div class="rowline">
        <label class="checkline">
          <input id="riskCheck" type="checkbox"/>
          <span class="muted"><b>I understand the risk</b> and want to enable automated trading.</span>
        </label>
        <div id="riskHint" class="dangertext" style="display:none;">
          Please tick the checkbox to enable “Start Algo”.
        </div>
      </div>
    </div>

    <div class="nav">
      <div><b>676Trades</b></div>
      <div style="display:flex;gap:12px;align-items:center;">
        <a href="/setup2.html">Setup</a>
        <a href="/billing.html">Billing</a>
        <a href="/account2.html">Account</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>

    <div class="card">
      <h1>Dashboard</h1>
      <div class="small">Beginner mode: choose pairs + lot size, save, then start the algo.</div>
      <hr/>

      <div class="kv">
        <div><b>Status</b><span id="statusBadge" class="badge off">OFF</span></div>
        <div><b>Pairs</b><span id="pairsText">-</span></div>
        <div><b>Lot size</b><span id="lotText">-</span></div>
        <div><b>EA</b><span id="eaBadge" class="badge dead">Offline ⚠️</span></div>
        <div><b>Last seen</b><span id="lastSeenText">-</span></div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="startBtn">Start Algo</button>
        <button id="stopBtn" class="danger">Stop Algo</button>
        <button id="refreshBtn" class="secondary">Refresh</button>
      </div>

      <div id="msg" class="toast"></div>
      <div class="smallmuted">Tip: If EA shows Offline, open MT5 and follow the Setup page.</div>
    </div>

    <div class="card">
      <h2>Basic Settings</h2>

      <div class="hint">
        <b>Recommended for beginners:</b> Start with <b>XAUUSD</b> and <b>0.01</b> lot size.
        Keep it simple (1–2 pairs).
      </div>

      <div class="row">
        <div>
          <div class="label-row">
            <label style="margin:10px 0 6px;">Trading Pairs</label>
            <span class="info">i
              <span class="tip">
                Click to select pairs below (multi-select), or type them separated by commas.
                Example: XAUUSD,EURUSD.
              </span>
            </span>
          </div>

          <input id="pairs" placeholder="XAUUSD" value="XAUUSD"/>

          <div class="chipwrap">
            <div class="chipgroup-title">Recommended</div>
            <div id="chipsRecommended" class="chips"></div>

            <div class="chipgroup-title">Advanced / Optional</div>
            <div class="small" style="opacity:0.78;margin-top:6px;">
              These can behave differently (higher volatility/spreads). Only use if you understand the risk.
            </div>
            <div id="chipsAdvanced" class="chips"></div>

            <div class="chiprow">
              <button id="clearPairsBtn" class="chipbtn" type="button">Clear</button>
              <button id="chooseBeginnerBtn" class="chipbtn" type="button">Beginner set (XAUUSD)</button>
            </div>
          </div>

          <div class="small" style="opacity:0.85;margin-top:10px;">
            You can select multiple pairs. Keep it to 1–2 if you're new.
          </div>
        </div>

        <div>
          <div class="label-row">
            <label style="margin:10px 0 6px;">Lot Size</label>
            <span class="info">i
              <span class="tip">
                Trade volume per position. Smaller = lower risk.
                0.01 is a common starting size.
              </span>
            </span>
          </div>
          <input id="lot" type="number" step="0.01" value="0.01"/>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="saveBtn">Save Settings</button>
        <button id="copyKeyBtn" class="secondary">Copy API Key</button>
      </div>

      <div id="msg2" class="toast"></div>

      <hr/>
      <div class="small">
        Need help installing MT5 + EA? Go to <a href="/setup2.html">Setup</a>.
      </div>
    </div>

    <footer class="footer">
      <div class="footer-inner">
        <span>© <span id="yr"></span> 676Trades</span>
        <span class="dot">·</span>
        <a href="/terms.html">Terms</a>
        <span class="dot">·</span>
        <a href="/privacy.html">Privacy</a>
        <span class="dot">·</span>
        <a href="/risk.html">Risk Disclosure</a>
        <span class="dot">·</span>
        <a href="mailto:support@676trades.org">Support</a>
      </div>
    </footer>

    <script>
      (function(){
        var el = document.getElementById("yr");
        if(el) el.textContent = new Date().getFullYear();
      })();
    </script>

  </div>

  <script src="app.js"></script>
  <script>
    // Mobile-friendly tooltip toggle
    (function(){
      document.querySelectorAll(".info").forEach(el=>{
        el.addEventListener("click", (e)=>{
          if(window.matchMedia("(max-width: 720px)").matches){
            e.preventDefault();
            e.stopPropagation();
            el.classList.toggle("open");
          }
        });
      });
      document.addEventListener("click", ()=>{
        document.querySelectorAll(".info.open").forEach(x=>x.classList.remove("open"));
      });
    })();

    const msg = document.getElementById("msg");
    const msg2 = document.getElementById("msg2");
    const startBtn = document.getElementById("startBtn");
    const riskCheck = document.getElementById("riskCheck");
    const riskHint = document.getElementById("riskHint");
    const pairsInput = document.getElementById("pairs");

    // Beginner-friendly chip sets
    // NOTE: symbols must exist on the broker; some brokers use BTCUSD/BTCUSDm/BTCUSD.c etc.
    const RECOMMENDED = [
      {sym:"XAUUSD", note:"gold"},
      {sym:"EURUSD", note:"major"},
      {sym:"GBPUSD", note:"major"},
      {sym:"USDJPY", note:"major"}
    ];

    const ADVANCED = [
      {sym:"BTCUSD", note:"crypto"},
      {sym:"NAS100", note:"index"},
      {sym:"US30",  note:"index"},
    ];

    function requireLogin(){
      if(!getToken()){
        window.location.href="/login.html";
        return false;
      }
      return true;
    }

    function updateStartGate(){
      const ok = !!riskCheck.checked;
      if(ok){
        startBtn.classList.remove("btn-disabled");
        riskHint.style.display = "none";
      }else{
        startBtn.classList.add("btn-disabled");
      }
      return ok;
    }
    riskCheck.addEventListener("change", updateStartGate);

    function normalizePairsStr(s){
      const parts = (s || "")
        .split(",")
        .map(x => x.trim().toUpperCase())
        .filter(Boolean);

      // unique preserve order
      const seen = new Set();
      const out = [];
      for(const p of parts){
        if(!seen.has(p)){
          seen.add(p);
          out.push(p);
        }
      }
      return out.join(",");
    }

    function getPairsArray(){
      const s = normalizePairsStr(pairsInput.value);
      return s ? s.split(",") : [];
    }

    function setPairsArray(arr){
      pairsInput.value = normalizePairsStr(arr.join(","));
    }

    function togglePair(sym){
      sym = (sym || "").trim().toUpperCase();
      if(!sym) return;
      const arr = getPairsArray();
      const idx = arr.indexOf(sym);
      if(idx >= 0) arr.splice(idx, 1);
      else arr.push(sym);
      setPairsArray(arr);
      renderChipsFromInput();
    }

    function renderChips(containerId, list){
      const el = document.getElementById(containerId);
      el.innerHTML = "";
      const selected = new Set(getPairsArray());
      list.forEach(item=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip" + (selected.has(item.sym) ? " on" : "");
        b.innerHTML = `${item.sym} <small>${item.note}</small>`;
        b.onclick = ()=> togglePair(item.sym);
        el.appendChild(b);
      });
    }

    function renderChipsFromInput(){
      renderChips("chipsRecommended", RECOMMENDED);
      renderChips("chipsAdvanced", ADVANCED);
    }

    // keep chips in sync if user types manually
    pairsInput.addEventListener("input", ()=>{
      // do not aggressively rewrite while typing, just refresh chip active state
      renderChipsFromInput();
    });

    pairsInput.addEventListener("blur", ()=>{
      pairsInput.value = normalizePairsStr(pairsInput.value);
      renderChipsFromInput();
    });

    document.getElementById("clearPairsBtn").onclick = ()=>{
      pairsInput.value = "";
      renderChipsFromInput();
    };

    document.getElementById("chooseBeginnerBtn").onclick = ()=>{
      pairsInput.value = "XAUUSD";
      renderChipsFromInput();
    };

    function pickPairs(s){
      return (s.pairs || s.pair || "XAUUSD");
    }

    function fillForm(s){
      const pairsVal = pickPairs(s);
      pairsInput.value = normalizePairsStr(pairsVal);
      document.getElementById("lot").value = (s.lot_size ?? 0.01);

      const badge = document.getElementById("statusBadge");
      badge.textContent = s.enabled ? "ON" : "OFF";
      badge.className = "badge " + (s.enabled ? "ok" : "off");

      document.getElementById("pairsText").textContent = pairsInput.value || "-";
      document.getElementById("lotText").textContent = (s.lot_size ?? "-");

      const eaBadge = document.getElementById("eaBadge");
      const lastSeen = document.getElementById("lastSeenText");

      if(s.ea_connected){
        eaBadge.textContent = "Connected ✅";
        eaBadge.className = "badge live";
      }else{
        eaBadge.textContent = "Offline ⚠️";
        eaBadge.className = "badge dead";
      }

      lastSeen.textContent = s.last_seen_at ? new Date(s.last_seen_at).toLocaleString() : "-";

      renderChipsFromInput();
    }

    async function refresh(){
      msg.textContent = "Loading...";
      try{
        const s = await api("/api/v1/status","GET");
        fillForm(s);
        msg.textContent = "";
      }catch(e){
        msg.textContent = "Error: " + e.message;
      }
    }

    document.getElementById("refreshBtn").onclick = refresh;

    startBtn.onclick = async ()=>{
      if(!updateStartGate()){
        riskHint.style.display = "block";
        msg.textContent = "Please confirm the risk disclaimer first.";
        return;
      }
      msg.textContent = "Starting...";
      try{
        await api("/api/v1/toggle","POST",{ enabled:true });
        await refresh();
        msg.textContent = "Started.";
      }catch(e){
        msg.textContent = "Error: " + e.message;
      }
    };

    document.getElementById("stopBtn").onclick = async ()=>{
      msg.textContent = "Stopping...";
      try{
        await api("/api/v1/toggle","POST",{ enabled:false });
        await refresh();
        msg.textContent = "Stopped.";
      }catch(e){
        msg.textContent = "Error: " + e.message;
      }
    };

    document.getElementById("saveBtn").onclick = async ()=>{
      msg2.textContent = "Saving...";
      try{
        const pairs = normalizePairsStr(pairsInput.value);
        if(!pairs){
          msg2.textContent = "Please choose at least 1 pair (example: XAUUSD).";
          return;
        }
        await api("/api/v1/settings","POST",{
          pairs,
          lot_size: Number(document.getElementById("lot").value)
        });
        msg2.textContent = "Saved. EA will pick this up on next poll.";
        await refresh();
      }catch(e){
        msg2.textContent = "Error: " + e.message;
      }
    };

    document.getElementById("copyKeyBtn").onclick = async ()=>{
      const key = getToken();
      await navigator.clipboard.writeText(key);
      msg2.textContent = "API key copied.";
    };

    // init
    if(requireLogin()){
      updateStartGate();
      renderChipsFromInput();
      refresh();
    }
  </script>
</body>
</html>
