<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>676Trades - Dashboard</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div><b>676Trades</b></div>
      <div style="display:flex;gap:12px;align-items:center;">
        <a href="/account2.html">Account</a>
        <a href="/billing.html">Billing</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>

    <!-- STATUS -->
    <div class="card">
      <h1>Dashboard</h1>
      <div class="small">Controls your MT5 EA. Changes apply on the next EA poll.</div>
      <hr/>

      <div class="kv">
        <div><b>Status</b><span id="statusBadge" class="badge off">OFF</span></div>
        <div><b>Pairs</b><span id="pairsText">-</span></div>
        <div><b>Lot size</b><span id="lotText">-</span></div>

        <!-- ✅ Heartbeat indicator -->
        <div><b>EA</b><span id="eaBadge" class="badge off">OFFLINE</span></div>
        <div><b>Last seen</b><span id="eaLastSeen">-</span></div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="startBtn">Start Algo</button>
        <button id="stopBtn" class="danger">Stop Algo</button>
        <button id="refreshBtn" class="secondary">Refresh</button>
      </div>

      <div id="msg" class="toast"></div>
    </div>

    <!-- SETTINGS -->
    <div class="card">
      <h2>Trading Settings</h2>

      <div class="row">
        <div>
          <label>Trading Pairs (comma-separated)</label>
          <input id="pairs" placeholder="XAUUSD,EURUSD,GBPUSD" />
        </div>
        <div>
          <label>Lot Size</label>
          <input id="lot" type="number" step="0.01"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>SL Mode</label>
          <select id="sl_mode">
            <option value="dynamic">Dynamic</option>
            <option value="fixed">Fixed</option>
          </select>
        </div>
        <div>
          <label>TP Mode</label>
          <select id="tp_mode">
            <option value="rr">Risk / Reward</option>
            <option value="pattern_mult">Pattern Mult</option>
            <option value="fixed">Fixed</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Min pips</label>
          <input id="min_pips" type="number"/>
        </div>
        <div>
          <label>SL buffer</label>
          <input id="sl_buffer_pips" type="number"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>RR</label>
          <input id="rr" type="number" step="0.1"/>
        </div>
        <div>
          <label>Pattern TP Mult</label>
          <input id="pattern_tp_mult" type="number" step="0.1"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fixed SL pips</label>
          <input id="fixed_sl_pips" type="number"/>
        </div>
        <div>
          <label>Fixed TP pips</label>
          <input id="fixed_tp_pips" type="number"/>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;">
        <button id="saveBtn">Save Settings</button>
        <button id="copyKeyBtn" class="secondary">Copy API Key</button>
      </div>

      <div id="msg2" class="toast"></div>
    </div>

    <!-- MT5 ONBOARDING -->
    <div class="card">
      <h2>MT5 Setup (Plug & Play)</h2>
      <div class="small">Follow these steps to connect your EA.</div>
      <hr/>

      <h3>Step 1 — Copy your API key</h3>
      <button onclick="copyKey()">Copy API Key</button>

      <h3 style="margin-top:18px;">Step 2 — Install the EA</h3>
      <ol class="small">
        <li>Open MT5</li>
        <li>File → Open Data Folder</li>
        <li>MQL5 → Experts</li>
        <li>Copy EA file there</li>
        <li>Restart MT5</li>
      </ol>
      <a href="#" class="secondary">Download EA (BinaryScalper.ex5)</a>

      <h3 style="margin-top:18px;">Step 3 — Allow WebRequest</h3>
      <ol class="small">
        <li>MT5 → Tools → Options → Expert Advisors</li>
        <li>Enable “Allow WebRequest for listed URLs”</li>
        <li>Add:</li>
      </ol>
      <code>https://api.676trades.org</code>

      <h3 style="margin-top:18px;">Step 4 — Attach EA</h3>
      <ol class="small">
        <li>Open chart (example: XAUUSD M5)</li>
        <li>Drag EA onto chart</li>
        <li>Paste API key into EA inputs</li>
        <li>Enable Algo Trading</li>
      </ol>

      <h3 style="margin-top:18px;">Step 5 — Confirm connection</h3>
      <div class="small">Check MT5 → Experts tab for “Backend ok”</div>
      <button class="secondary" onclick="refresh()">Test Backend Now</button>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const msg = document.getElementById("msg");
    const msg2 = document.getElementById("msg2");

    function copyKey(){
      navigator.clipboard.writeText(getToken());
      msg2.textContent = "API key copied.";
    }

    function fill(s){
      const pairsVal = (s.pairs || s.pair || "XAUUSD");

      document.getElementById("pairs").value = pairsVal;
      document.getElementById("lot").value = s.lot_size ?? 0.01;
      document.getElementById("sl_mode").value = s.sl_mode ?? "dynamic";
      document.getElementById("tp_mode").value = s.tp_mode ?? "rr";
      document.getElementById("min_pips").value = s.min_pips ?? 50;
      document.getElementById("sl_buffer_pips").value = s.sl_buffer_pips ?? 5;
      document.getElementById("rr").value = s.rr ?? 1.0;
      document.getElementById("pattern_tp_mult").value = s.pattern_tp_mult ?? 1.5;
      document.getElementById("fixed_sl_pips").value = s.fixed_sl_pips ?? 50;
      document.getElementById("fixed_tp_pips").value = s.fixed_tp_pips ?? 50;

      document.getElementById("pairsText").textContent = pairsVal;
      document.getElementById("lotText").textContent = (s.lot_size ?? "-");

      const b = document.getElementById("statusBadge");
      b.textContent = s.enabled ? "ON" : "OFF";
      b.className = "badge " + (s.enabled ? "ok" : "off");

      // ✅ Heartbeat UI
      const eaBadge = document.getElementById("eaBadge");
      const eaLastSeen = document.getElementById("eaLastSeen");

      if (s.last_seen_at) {
        const last = new Date(s.last_seen_at);
        const diffSec = (Date.now() - last.getTime()) / 1000;

        // connected if heartbeat within 180 seconds
        const connected = diffSec <= 180;

        eaBadge.textContent = connected ? "CONNECTED" : "OFFLINE";
        eaBadge.className = "badge " + (connected ? "ok" : "off");

        const sym = s.last_seen_symbol ? ` (${s.last_seen_symbol})` : "";
        eaLastSeen.textContent = last.toLocaleString() + sym;
      } else {
        eaBadge.textContent = "OFFLINE";
        eaBadge.className = "badge off";
        eaLastSeen.textContent = "-";
      }
    }

    async function refresh(){
      msg.textContent = "Loading...";
      try{
        const s = await api("/api/v1/status");
        fill(s);
        msg.textContent = "";
      }catch(e){
        msg.textContent = e.message;
      }
    }

    document.getElementById("startBtn").onclick = ()=>api("/api/v1/toggle","POST",{enabled:true}).then(refresh);
    document.getElementById("stopBtn").onclick  = ()=>api("/api/v1/toggle","POST",{enabled:false}).then(refresh);

    document.getElementById("saveBtn").onclick  = ()=>{
      msg2.textContent = "Saving...";
      return api("/api/v1/settings","POST",{
        pairs: document.getElementById("pairs").value,
        lot_size: Number(document.getElementById("lot").value),
        sl_mode: document.getElementById("sl_mode").value,
        tp_mode: document.getElementById("tp_mode").value,
        min_pips: Number(document.getElementById("min_pips").value),
        sl_buffer_pips: Number(document.getElementById("sl_buffer_pips").value),
        rr: Number(document.getElementById("rr").value),
        pattern_tp_mult: Number(document.getElementById("pattern_tp_mult").value),
        fixed_sl_pips: Number(document.getElementById("fixed_sl_pips").value),
        fixed_tp_pips: Number(document.getElementById("fixed_tp_pips").value)
      }).then(()=>{
        msg2.textContent="Saved.";
        return refresh();
      }).catch(e=>{
        msg2.textContent = "Error: " + e.message;
      });
    };

    document.getElementById("copyKeyBtn").onclick = async ()=>{
      await navigator.clipboard.writeText(getToken());
      msg2.textContent = "API key copied.";
    };

    document.getElementById("refreshBtn").onclick = refresh;

    refresh();
    // optional auto-refresh every 30s so the EA indicator updates
    setInterval(refresh, 30000);
  </script>
</body>
</html>
