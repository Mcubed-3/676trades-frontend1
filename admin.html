<!doctype html> 
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>676Trades - Admin</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .grid2{display:grid;grid-template-columns:1.2fr 0.8fr;gap:16px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left;vertical-align:top}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .pill.ok{background:rgba(0,255,140,.12)}
    .pill.bad{background:rgba(255,80,80,.12)}
    .pill.warn{background:rgba(255,200,0,.12)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .clickrow{cursor:pointer}
    .clickrow:hover{background:rgba(255,255,255,.03)}
    .muted{opacity:.75}
    input,button,select{max-width:100%}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:900px){.row2{grid-template-columns:1fr}}
    .box{padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;margin-bottom:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div><b>676Trades</b> <span class="muted">Admin</span></div>
      <div style="display:flex;gap:12px;align-items:center;">
        <a href="/dashboard.html">Dashboard</a>
        <a href="#" onclick="logoutUser()">Logout user</a>
      </div>
    </div>

    <div class="card">
      <h1>Admin Console</h1>
      <div class="small">View users + EA connectivity (heartbeat) + recent trades + errors.</div>
      <hr/>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <button id="setAdminTokenBtn" class="secondary">Set Admin Token</button>
        <input id="q" placeholder="Search email..." style="min-width:240px;"/>
        <button id="refreshBtn">Refresh</button>
        <span id="msg" class="small"></span>
      </div>
    </div>

    <div class="grid2">
      <!-- USERS -->
      <div class="card">
        <h2 style="margin-top:0;">Users</h2>
        <div class="small muted">Click a row to view details.</div>
        <div style="overflow:auto;margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Plan</th>
                <th>Sub</th>
                <th>EA</th>
                <th>Pairs</th>
                <th>Last seen</th>
              </tr>
            </thead>
            <tbody id="usersBody"></tbody>
          </table>
        </div>
      </div>

      <!-- DETAILS -->
      <div class="card">
        <h2 style="margin-top:0;">User details</h2>
        <div id="details" class="small muted">Select a user.</div>

        <div id="actions" style="margin-top:12px;display:none;gap:10px;flex-wrap:wrap;">
          <button id="enableBtn">Force Enable EA</button>
          <button id="disableBtn" class="danger">Force Disable EA</button>
          <button id="rotateKeyBtn" class="secondary">Rotate API Key</button>
          <button id="clearTradesBtn" class="secondary">Clear Trades</button>
          <button id="resetPwBtn" class="secondary">Reset Password</button>
        </div>

        <!-- Billing override -->
        <div id="billingBox" style="display:none;margin-top:14px;">
          <hr/>
          <h3 style="margin:10px 0;">Billing override</h3>
          <div class="small muted">Grant pro manually, set status, or extend trial.</div>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label>Plan</label>
              <select id="ovPlan">
                <option value="">(no change)</option>
                <option value="free">free</option>
                <option value="pro">pro</option>
              </select>
            </div>
            <div>
              <label>Subscription status</label>
              <select id="ovSub">
                <option value="">(no change)</option>
                <option value="none">none</option>
                <option value="active">active</option>
                <option value="past_due">past_due</option>
                <option value="canceled">canceled</option>
              </select>
            </div>
          </div>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label>Extend trial by days (0 clears trial)</label>
              <input id="ovTrialDays" type="number" placeholder="e.g. 7"/>
            </div>
            <div>
              <label>Or set trial until (ISO)</label>
              <input id="ovTrialUntil" placeholder="2026-02-01T00:00:00Z"/>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
            <button id="applyBillingBtn">Apply override</button>
            <button id="clearInputsBtn" class="secondary">Clear inputs</button>
          </div>

          <div id="billMsg" class="small muted" style="margin-top:8px;"></div>
        </div>

        <!-- Errors -->
        <div id="errorsBox" style="display:none;margin-top:14px;">
          <hr/>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <h3 style="margin:10px 0;">Errors (latest)</h3>
            <button id="refreshErrorsBtn" class="secondary">Refresh Errors</button>
          </div>
          <div id="errors" class="small muted">—</div>
        </div>

        <div style="margin-top:14px;">
          <h3 style="margin:10px 0;">Recent trades</h3>
          <div id="trades" class="small muted">—</div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    function getAdminToken(){ return sessionStorage.getItem("adminToken") || ""; }
    function setAdminToken(t){ sessionStorage.setItem("adminToken", t); }

    function logoutUser(){
      localStorage.removeItem("apiKey");
      window.location.href="/login.html";
    }

    async function adminFetch(path, method="GET", body=null){
      const token = getAdminToken();
      if(!token) throw new Error("Admin token not set. Click 'Set Admin Token'.");

      const headers = { "Content-Type":"application/json", "X-Admin-Token": token };
      const res = await fetch(`${BACKEND}${path}`, {
        method,
        headers,
        body: body ? JSON.stringify(body) : null
      });

      const text = await res.text();
      let data;
      try{ data = JSON.parse(text); } catch(e){ data = { raw:text }; }
      if(!res.ok) throw new Error(data?.error || data?.message || `HTTP ${res.status}`);
      return data;
    }

    function pill(text, cls){
      return `<span class="pill ${cls}">${text}</span>`;
    }

    function fmt(dt){
      if(!dt) return "—";
      try{ return new Date(dt).toLocaleString(); }catch(e){ return dt; }
    }

    async function loadUsers(){
      const msg = document.getElementById("msg");
      msg.textContent = "Loading users...";
      const q = document.getElementById("q").value.trim();
      const data = await adminFetch(`/admin/users${q ? `?q=${encodeURIComponent(q)}` : ""}`);
      const body = document.getElementById("usersBody");
      body.innerHTML = "";

      for(const u of data.items){
        const plan = u.plan || "free";
        const sub = u.subscription_status || "none";

        const planP = plan === "pro" ? pill("pro","ok") : pill("free","warn");

        let subCls = "warn";
        if(sub === "active") subCls = "ok";
        if(sub === "past_due") subCls = "warn";
        if(sub === "canceled") subCls = "bad";
        const subP = pill(sub, subCls);

        const eaP = u.online ? pill("online","ok") : pill("offline","bad");
        const lastSeen = fmt(u.last_seen_at);

        const tr = document.createElement("tr");
        tr.className = "clickrow";
        tr.innerHTML = `
          <td class="mono">${u.id}</td>
          <td>${u.email}</td>
          <td>${planP}</td>
          <td>${subP}</td>
          <td>${eaP}</td>
          <td class="mono">${u.pairs || ""}</td>
          <td>${lastSeen}</td>
        `;
        tr.onclick = () => loadUser(u.id);
        body.appendChild(tr);
      }

      msg.textContent = `Loaded ${data.items.length} user(s).`;
    }

    let currentUserId = null;

    async function loadErrorsForUser(userId){
      const box = document.getElementById("errorsBox");
      const el = document.getElementById("errors");
      box.style.display = "block";
      el.textContent = "Loading errors...";
      const data = await adminFetch(`/admin/errors?user_id=${userId}&limit=40`);

      if(!data.items || data.items.length === 0){
        el.textContent = "No errors logged for this user.";
        return;
      }

      el.innerHTML = data.items.slice(0, 20).map(e => `
        <div class="box">
          <div><b>${e.source}</b> <span class="muted">• ${fmt(e.created_at)}</span></div>
          <div class="mono" style="margin-top:6px;white-space:pre-wrap;">${(e.message || "").replaceAll("<","&lt;")}</div>
          ${e.context ? `<div class="muted mono" style="margin-top:6px;white-space:pre-wrap;">${(e.context || "").replaceAll("<","&lt;")}</div>` : ""}
        </div>
      `).join("");
    }

    async function loadUser(id){
      currentUserId = id;
      const details = document.getElementById("details");
      const trades = document.getElementById("trades");
      const actions = document.getElementById("actions");
      const billingBox = document.getElementById("billingBox");
      const billMsg = document.getElementById("billMsg");

      details.textContent = "Loading user...";
      trades.textContent = "Loading trades...";
      actions.style.display = "none";
      billingBox.style.display = "none";
      billMsg.textContent = "";
      document.getElementById("errorsBox").style.display = "none";

      const data = await adminFetch(`/admin/user/${id}/activity`);
      const u = data.user;

      actions.style.display = "flex";
      billingBox.style.display = "block";

      details.innerHTML = `
        <div><b>ID:</b> <span class="mono">${u.id}</span></div>
        <div><b>Email:</b> ${u.email}</div>
        <div><b>Plan:</b> <span class="mono">${u.plan}</span></div>
        <div><b>Subscription:</b> <span class="mono">${u.subscription_status}</span></div>
        <div><b>Trial ends:</b> <span class="mono">${u.trial_ends_at ? fmt(u.trial_ends_at) : "—"}</span></div>
        <div><b>Enabled:</b> <span class="mono">${u.enabled}</span></div>
        <div><b>Pairs:</b> <span class="mono">${u.pairs}</span></div>
        <div><b>Lot:</b> <span class="mono">${u.lot_size}</span></div>
        <hr/>
        <div><b>Created:</b> ${fmt(u.created_at)}</div>
        <div><b>Last login:</b> ${fmt(u.last_login_at)}</div>
        <div><b>Last settings update:</b> ${fmt(u.last_settings_at)}</div>
        <hr/>
        <div><b>Last EA heartbeat:</b> ${fmt(u.last_seen_at)}</div>
        <div><b>EA symbol:</b> <span class="mono">${u.last_seen_symbol || "—"}</span></div>
        <div><b>EA TF:</b> <span class="mono">${u.last_seen_tf || "—"}</span></div>
        <div><b>Last IP:</b> <span class="mono">${u.last_seen_ip || "—"}</span></div>
      `;

      document.getElementById("disableBtn").onclick = async () => {
        if(!confirm(`Force DISABLE EA for ${u.email}?`)) return;
        await adminFetch(`/admin/user/${u.id}/force-disable`, "POST", {});
        await loadUsers(); await loadUser(u.id);
        document.getElementById("msg").textContent = "EA disabled.";
      };

      document.getElementById("enableBtn").onclick = async () => {
        if(!confirm(`Force ENABLE EA for ${u.email}? (Must be paid/trial active)`)) return;
        await adminFetch(`/admin/user/${u.id}/force-enable`, "POST", {});
        await loadUsers(); await loadUser(u.id);
        document.getElementById("msg").textContent = "EA enabled.";
      };

      document.getElementById("rotateKeyBtn").onclick = async () => {
        if(!confirm(`Rotate API key for ${u.email}?\n\nThis will DISABLE the EA until they update their key in MT5.`)) return;
        const r = await adminFetch(`/admin/user/${u.id}/rotate-key`, "POST", {});
        await loadUsers(); await loadUser(u.id);

        try{
          await navigator.clipboard.writeText(r.api_key);
          document.getElementById("msg").textContent = "New API key generated + copied. EA disabled.";
        }catch(e){
          alert("New API Key:\n\n" + r.api_key);
          document.getElementById("msg").textContent = "New API key generated. (Clipboard blocked)";
        }
      };

      document.getElementById("clearTradesBtn").onclick = async () => {
        if(!confirm(`Clear ALL trades for ${u.email}?`)) return;
        const r = await adminFetch(`/admin/user/${u.id}/clear-trades`, "POST", {});
        document.getElementById("msg").textContent = `Deleted ${r.deleted} trade(s).`;
        await loadUser(u.id);
      };

      document.getElementById("resetPwBtn").onclick = async () => {
        if(!confirm(`Reset password for ${u.email}?\n\nThis will DISABLE the EA for safety.`)) return;
        const r = await adminFetch(`/admin/user/${u.id}/reset-password`, "POST", {});
        try{
          await navigator.clipboard.writeText(r.temp_password);
          alert(`Temp password copied.\n\nUser: ${r.email}`);
        }catch(e){
          alert(`Temp password:\n\n${r.temp_password}`);
        }
        document.getElementById("msg").textContent = "Password reset. Temp password copied/shown. EA disabled.";
        await loadUsers(); await loadUser(u.id);
      };

      // Billing override
      document.getElementById("applyBillingBtn").onclick = async () => {
        const plan = document.getElementById("ovPlan").value.trim();
        const subscription_status = document.getElementById("ovSub").value.trim();
        const trial_days_raw = document.getElementById("ovTrialDays").value.trim();
        const trial_until = document.getElementById("ovTrialUntil").value.trim();

        const payload = {};
        if(plan) payload.plan = plan;
        if(subscription_status) payload.subscription_status = subscription_status;
        if(trial_days_raw !== "") payload.trial_days = Number(trial_days_raw);
        if(trial_until) payload.trial_until = trial_until;

        if(Object.keys(payload).length === 0){
          billMsg.textContent = "Nothing to apply. Choose at least one field.";
          return;
        }

        billMsg.textContent = "Applying...";
        const r = await adminFetch(`/admin/user/${u.id}/set-billing`, "POST", payload);
        billMsg.textContent = `Updated: plan=${r.plan}, sub=${r.subscription_status}, trial=${r.trial_ends_at || "—"}, enabled=${r.enabled}`;

        await loadUsers();
        await loadUser(u.id);
      };

      document.getElementById("clearInputsBtn").onclick = () => {
        document.getElementById("ovPlan").value = "";
        document.getElementById("ovSub").value = "";
        document.getElementById("ovTrialDays").value = "";
        document.getElementById("ovTrialUntil").value = "";
        billMsg.textContent = "";
      };

      // Errors
      document.getElementById("refreshErrorsBtn").onclick = () => loadErrorsForUser(u.id);
      await loadErrorsForUser(u.id);

      // Trades
      if(!data.trades || data.trades.length === 0){
        trades.textContent = "No trades posted yet.";
        return;
      }

      trades.innerHTML = data.trades.slice(0, 12).map(t => `
        <div class="box">
          <div><b>${t.symbol}</b> <span class="mono">${t.side}</span> | vol <span class="mono">${t.volume}</span></div>
          <div class="muted">Opened: ${fmt(t.opened_at)}</div>
          <div class="mono muted">entry ${t.entry ?? "—"} | sl ${t.sl ?? "—"} | tp ${t.tp ?? "—"}</div>
          <div>profit: <span class="mono">${t.profit ?? "—"}</span></div>
        </div>
      `).join("");
    }

    document.getElementById("setAdminTokenBtn").onclick = () => {
      const t = prompt("Paste ADMIN_TOKEN (stored only in this browser session):", getAdminToken());
      if(t) setAdminToken(t.trim());
    };

    document.getElementById("refreshBtn").onclick = loadUsers;
    document.getElementById("q").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") loadUsers();
    });

    loadUsers().catch(e => document.getElementById("msg").textContent = "Error: " + e.message);
  </script>
</body>
</html>
