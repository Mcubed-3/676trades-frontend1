<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>676Trades - Admin</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .grid2{display:grid;grid-template-columns:1.2fr 0.8fr;gap:16px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left;vertical-align:top}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .pill.ok{background:rgba(0,255,140,.12)}
    .pill.bad{background:rgba(255,80,80,.12)}
    .pill.warn{background:rgba(255,200,0,.12)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .clickrow{cursor:pointer}
    .clickrow:hover{background:rgba(255,255,255,.03)}
    .muted{opacity:.75}
    input,button,select{max-width:100%}
    .rowflex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabbtn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:transparent;color:inherit;cursor:pointer}
    .tabbtn.active{background:rgba(255,255,255,.08)}
    .chartbox{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;margin-top:10px}
    .tiny{font-size:12px;opacity:.75}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div><b>676Trades</b> <span class="muted">Admin</span></div>
      <div style="display:flex;gap:12px;align-items:center;">
        <a href="/dashboard.html">Dashboard</a>
        <a href="#" onclick="logoutUser()">Logout user</a>
      </div>
    </div>

    <!-- MODE / TOKEN -->
    <div class="card">
      <h1>Admin Console</h1>
      <div class="small">View users + EA connectivity (heartbeat) + recent trades.</div>
      <hr/>

      <div class="rowflex">
        <div class="tabs">
          <button id="modeAdminBtn" class="tabbtn">Admin mode</button>
          <button id="modeSupportBtn" class="tabbtn">Support mode (read-only)</button>
        </div>

        <button id="setTokenBtn" class="secondary">Set Token</button>

        <span class="tiny">Mode:</span>
        <span id="modeText" class="pill warn">—</span>

        <span class="tiny">Token:</span>
        <span id="tokenText" class="mono tiny">not set</span>
      </div>

      <div class="rowflex" style="margin-top:10px;">
        <input id="q" placeholder="Search email..." style="min-width:240px;"/>
        <button id="refreshBtn">Refresh</button>
        <span id="msg" class="small"></span>
      </div>

      <div class="tiny" style="margin-top:10px;">
        • Admin mode uses <span class="mono">X-Admin-Token</span> and calls <span class="mono">/admin/*</span><br/>
        • Support mode uses <span class="mono">X-Support-Token</span> and calls <span class="mono">/support/*</span>
      </div>
    </div>

    <!-- CHARTS PLACEHOLDER -->
    <div class="card">
      <h2 style="margin-top:0;">Charts (placeholder)</h2>
      <div class="small muted">
        Coming next: quick insights like online EAs, plan split, signups, and trades volume.
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="chartbox">
          <div><b>EA Online vs Offline</b></div>
          <div class="tiny">Placeholder — we’ll render a small chart here.</div>
          <div id="chartOnline" class="tiny muted" style="margin-top:8px;">—</div>
        </div>

        <div class="chartbox">
          <div><b>Plan split (Free vs Pro)</b></div>
          <div class="tiny">Placeholder — we’ll render a small chart here.</div>
          <div id="chartPlan" class="tiny muted" style="margin-top:8px;">—</div>
        </div>
      </div>

      <div class="chartbox">
        <div><b>Recent trades (last 50 across selected user)</b></div>
        <div class="tiny">Placeholder — for now, view in the User details panel.</div>
      </div>
    </div>

    <div class="grid2">
      <!-- USERS -->
      <div class="card">
        <h2 style="margin-top:0;">Users</h2>
        <div class="small muted">Click a row to view details.</div>
        <div style="overflow:auto;margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Plan</th>
                <th>Sub</th>
                <th>EA</th>
                <th>Pairs</th>
                <th>Last seen</th>
              </tr>
            </thead>
            <tbody id="usersBody"></tbody>
          </table>
        </div>
      </div>

      <!-- DETAILS -->
      <div class="card">
        <h2 style="margin-top:0;">User details</h2>
        <div id="details" class="small muted">Select a user.</div>

        <div style="margin-top:14px;">
          <h3 style="margin:10px 0;">Recent trades</h3>
          <div id="trades" class="small muted">—</div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    // =========================
    // Mode + token storage
    // =========================
    const MODE_KEY = "adminMode"; // "admin" | "support"
    const ADMIN_TOKEN_KEY = "adminToken";
    const SUPPORT_TOKEN_KEY = "supportToken";

    function getMode(){ return sessionStorage.getItem(MODE_KEY) || "admin"; }
    function setMode(m){ sessionStorage.setItem(MODE_KEY, m); updateModeUI(); }

    function getAdminToken(){ return sessionStorage.getItem(ADMIN_TOKEN_KEY) || ""; }
    function setAdminToken(t){ sessionStorage.setItem(ADMIN_TOKEN_KEY, t); }

    function getSupportToken(){ return sessionStorage.getItem(SUPPORT_TOKEN_KEY) || ""; }
    function setSupportToken(t){ sessionStorage.setItem(SUPPORT_TOKEN_KEY, t); }

    function getActiveToken(){
      return (getMode()==="support") ? getSupportToken() : getAdminToken();
    }

    function logoutUser(){
      localStorage.removeItem("apiKey");
      window.location.href="/login.html";
    }

    function pill(text, cls){
      return `<span class="pill ${cls}">${text}</span>`;
    }

    function fmt(dt){
      if(!dt) return "—";
      try{ return new Date(dt).toLocaleString(); }catch(e){ return dt; }
    }

    function updateModeUI(){
      const mode = getMode();
      const adminBtn = document.getElementById("modeAdminBtn");
      const supportBtn = document.getElementById("modeSupportBtn");
      adminBtn.classList.toggle("active", mode==="admin");
      supportBtn.classList.toggle("active", mode==="support");

      const modeText = document.getElementById("modeText");
      if(mode==="support"){
        modeText.className = "pill warn";
        modeText.textContent = "support";
      }else{
        modeText.className = "pill ok";
        modeText.textContent = "admin";
      }

      const tok = getActiveToken();
      document.getElementById("tokenText").textContent = tok ? ("set (" + tok.slice(0,6) + "… )") : "not set";
    }

    // =========================
    // Admin/Support fetch wrapper
    // =========================
    async function staffFetch(path, method="GET", body=null){
      const mode = getMode();
      const token = getActiveToken();
      if(!token){
        throw new Error((mode==="support")
          ? "Support token not set. Click 'Set Token'."
          : "Admin token not set. Click 'Set Token'.");
      }

      const headers = { "Content-Type":"application/json" };
      if(mode === "support") headers["X-Support-Token"] = token;
      else headers["X-Admin-Token"] = token;

      const res = await fetch(`${BACKEND}${path}`, {
        method,
        headers,
        body: body ? JSON.stringify(body) : null
      });

      const text = await res.text();
      let data;
      try{ data = JSON.parse(text); } catch(e){ data = { raw:text }; }

      if(!res.ok) throw new Error(data?.error || data?.message || `HTTP ${res.status}`);
      return data;
    }

    function apiPrefix(){
      return (getMode()==="support") ? "/support" : "/admin";
    }

    // =========================
    // Charts placeholder (text summaries for now)
    // =========================
    function renderChartSummaries(users){
      const total = users.length;
      const online = users.filter(u => !!u.online).length;
      const offline = total - online;

      const pro = users.filter(u => (u.plan||"").toLowerCase()==="pro").length;
      const free = total - pro;

      document.getElementById("chartOnline").textContent =
        total ? `Online: ${online} | Offline: ${offline} | Total: ${total}` : "—";

      document.getElementById("chartPlan").textContent =
        total ? `Pro: ${pro} | Free: ${free} | Total: ${total}` : "—";
    }

    // =========================
    // Load users + details
    // =========================
    async function loadUsers(){
      const msg = document.getElementById("msg");
      msg.textContent = "Loading users...";
      const q = document.getElementById("q").value.trim();

      const url = `${apiPrefix()}/users${q ? `?q=${encodeURIComponent(q)}` : ""}`;
      const data = await staffFetch(url);

      const body = document.getElementById("usersBody");
      body.innerHTML = "";

      const items = data.items || [];
      renderChartSummaries(items);

      for(const u of items){
        const plan = (u.plan || "free").toLowerCase();
        const sub = (u.subscription_status || "none").toLowerCase();

        const planP = (plan === "pro") ? pill("pro","ok") : pill("free","warn");

        let subCls = "warn";
        if(sub === "active") subCls = "ok";
        if(sub === "past_due") subCls = "warn";
        if(sub === "canceled") subCls = "bad";
        const subP = pill(sub, subCls);

        const eaP = u.online ? pill("online","ok") : pill("offline","bad");
        const lastSeen = fmt(u.last_seen_at);

        const tr = document.createElement("tr");
        tr.className = "clickrow";
        tr.innerHTML = `
          <td class="mono">${u.id}</td>
          <td>${u.email}</td>
          <td>${planP}</td>
          <td>${subP}</td>
          <td>${eaP}</td>
          <td class="mono">${u.pairs || ""}</td>
          <td>${lastSeen}</td>
        `;
        tr.onclick = () => loadUser(u.id);
        body.appendChild(tr);
      }

      msg.textContent = `Loaded ${items.length} user(s).`;
    }

    async function loadUser(id){
      const details = document.getElementById("details");
      const trades = document.getElementById("trades");
      details.textContent = "Loading user...";
      trades.textContent = "Loading trades...";

      const data = await staffFetch(`${apiPrefix()}/user/${id}/activity`);
      const u = data.user || {};

      // NOTE: support endpoints don't include last_seen_ip etc; keep graceful fallbacks.
      details.innerHTML = `
        <div><b>ID:</b> <span class="mono">${u.id ?? "—"}</span></div>
        <div><b>Email:</b> ${u.email ?? "—"}</div>
        <div><b>Plan:</b> <span class="mono">${u.plan ?? "—"}</span></div>
        <div><b>Subscription:</b> <span class="mono">${u.subscription_status ?? "—"}</span></div>
        <div><b>Enabled:</b> <span class="mono">${u.enabled ?? "—"}</span></div>
        <div><b>Pairs:</b> <span class="mono">${u.pairs ?? "—"}</span></div>
        <div><b>Lot:</b> <span class="mono">${u.lot_size ?? "—"}</span></div>
        <hr/>
        <div><b>Created:</b> ${fmt(u.created_at)}</div>
        <div><b>Last login:</b> ${fmt(u.last_login_at)}</div>
        <div><b>Last settings update:</b> ${fmt(u.last_settings_at)}</div>
        <hr/>
        <div><b>Last EA heartbeat:</b> ${fmt(u.last_seen_at)}</div>
        <div><b>EA symbol:</b> <span class="mono">${u.last_seen_symbol || "—"}</span></div>
        <div><b>EA TF:</b> <span class="mono">${u.last_seen_tf || "—"}</span></div>
        ${u.last_seen_ip ? `<div><b>Last IP:</b> <span class="mono">${u.last_seen_ip}</span></div>` : ``}
      `;

      const list = data.trades || [];
      if(list.length === 0){
        trades.textContent = "No trades posted yet.";
        return;
      }

      trades.innerHTML = list.slice(0, 12).map(t => `
        <div style="padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;margin-bottom:10px;">
          <div><b>${t.symbol}</b> <span class="mono">${t.side}</span> | vol <span class="mono">${t.volume}</span></div>
          <div class="muted">Opened: ${fmt(t.opened_at)}</div>
          <div class="mono muted">entry ${t.entry ?? "—"} | sl ${t.sl ?? "—"} | tp ${t.tp ?? "—"}</div>
          <div>profit: <span class="mono">${t.profit ?? "—"}</span></div>
        </div>
      `).join("");
    }

    // =========================
    // Wiring UI
    // =========================
    document.getElementById("modeAdminBtn").onclick = ()=> setMode("admin");
    document.getElementById("modeSupportBtn").onclick = ()=> setMode("support");

    document.getElementById("setTokenBtn").onclick = () => {
      const mode = getMode();
      const current = getActiveToken();
      const label = (mode==="support") ? "Paste SUPPORT_TOKEN (stored only in this browser session):"
                                      : "Paste ADMIN_TOKEN (stored only in this browser session):";
      const t = prompt(label, current);
      if(!t) return;

      if(mode==="support") setSupportToken(t.trim());
      else setAdminToken(t.trim());

      updateModeUI();
    };

    document.getElementById("refreshBtn").onclick = ()=> loadUsers().catch(e=>{
      document.getElementById("msg").textContent = "Error: " + e.message;
    });

    document.getElementById("q").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") document.getElementById("refreshBtn").click();
    });

    // init
    updateModeUI();
    loadUsers().catch(e => document.getElementById("msg").textContent = "Error: " + e.message);
  </script>
</body>
</html>
