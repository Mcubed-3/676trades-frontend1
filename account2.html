<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>676Trades - Account</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<div class="container">
  <div class="nav">
    <div><b>676Trades</b></div>
    <div style="display:flex;gap:12px;">
      <a href="/dashboard.html">Dashboard</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
  </div>

  <div class="card">
    <h1>Account</h1>
    <div class="small">Profile and API key management.</div>
    <hr/>

    <div class="kv">
      <div><b>Email</b><span id="email">-</span></div>
      <div><b>Display name</b><span id="nameText">-</span></div>
      <div><b>Created</b><span id="created">-</span></div>
      <div><b>Last login</b><span id="last">-</span></div>
    </div>

    <label>Display name</label>
    <input id="display_name"/>

    <div style="margin-top:12px;display:flex;gap:10px;">
      <button id="saveNameBtn">Save</button>
      <button onclick="navigator.clipboard.writeText(getToken())" class="secondary">Copy API Key</button>
    </div>

    <hr/>

    <h2>Rotate API Key</h2>
    <div class="small">You must update the EA after rotating.</div>
    <input id="pw" type="password" placeholder="Confirm password"/>
    <button id="rotateBtn" class="danger">Rotate Key</button>

    <div id="msg" class="toast"></div>
  </div>
</div>

<script src="app.js"></script>
<script>
  const msg = document.getElementById("msg");

  async function load(){
    const me = await api("/account/me");
    email.textContent = me.email;
    nameText.textContent = me.display_name || "-";
    created.textContent = new Date(me.created_at).toLocaleString();
    last.textContent = me.last_login_at ? new Date(me.last_login_at).toLocaleString() : "-";
    display_name.value = me.display_name || "";
  }

  saveNameBtn.onclick = ()=>api("/account/profile","POST",{display_name:display_name.value}).then(load);
  rotateBtn.onclick = ()=>api("/auth/rotate-key","POST",{email:email.textContent,password:pw.value})
    .then(r=>{ setToken(r.api_key); navigator.clipboard.writeText(r.api_key); msg.textContent="Rotated."; });

  load();
</script>
</body>
</html>
